# MedAI Backend - Federated Learning for Pneumonia Detection

Backend API for MedAI with federated learning support.

## ğŸ“ Directory Structure

```
backend/
â”œâ”€â”€ app.py                          # Main Flask application
â”œâ”€â”€ requirements.txt                # Python dependencies
â”œâ”€â”€ uploads/                        # Uploaded X-ray images
â”œâ”€â”€ static/
â”‚   â””â”€â”€ gradcam_output/            # Grad-CAM visualization outputs
â””â”€â”€ federated/                     # Federated learning module
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ fl_server.py               # Federated server orchestration
    â”œâ”€â”€ fl_client.py               # Hospital client simulation
    â”œâ”€â”€ fl_aggregator.py           # FedAvg aggregation
    â”œâ”€â”€ fl_config.py               # Configuration
    â””â”€â”€ federated_api.py           # API endpoints
```

## ğŸš€ Quick Start

### 1. Install Dependencies

```bash
cd backend
pip install -r requirements.txt
```

### 2. Place Model Files

Put your trained models in the `models/` directory:

```
../models/
â”œâ”€â”€ cnn_model.h5
â”œâ”€â”€ vgg19_model.h5
â”œâ”€â”€ resnet50_model.h5
â”œâ”€â”€ densenet121_model.h5
â””â”€â”€ federated/
    â”œâ”€â”€ global_model.h5         # Generated by training
    â”œâ”€â”€ training_history.json   # Generated by training
    â””â”€â”€ rounds/                 # Generated by training
```

### 3. Train Federated Model (One-time)

```bash
cd federated
python fl_server.py
```

This will:
- âœ… Initialize 8 hospital clients
- âœ… Simulate data distribution
- âœ… Train for 6 rounds
- âœ… Save `global_model.h5`
- âœ… Generate training history

**Note**: Training uses simulated data. Replace with real chest X-ray dataset in production.

### 4. Start Backend Server

```bash
cd ..  # Back to backend/
python app.py
```

Server runs on `http://localhost:5000`

## ğŸ”Œ API Endpoints

### Standard Models

- **POST** `/api/predict` - Make prediction with any model
  - Body: `multipart/form-data`
  - Fields: `image` (file), `model` (string)

- **GET** `/api/models/metrics` - Get model performance metrics

### Federated Learning

- **POST** `/api/federated/predict` - Predict using federated model
- **GET** `/api/federated/status` - Check training status
- **GET** `/api/federated/history` - Get training history
- **GET** `/api/federated/hospitals` - Get hospital information

### Utility

- **GET** `/api/health` - Health check
- **GET** `/` - API information

## ğŸ¥ Federated Learning Configuration

Edit `federated/fl_config.py`:

```python
FL_CONFIG = {
    'num_clients': 8,              # Number of hospitals
    'rounds': 6,                   # Training rounds
    'epochs_per_round': 5,         # Local epochs
    'batch_size': 32,
    'learning_rate': 0.001,
}
```

## ğŸ” Privacy Features

- âœ… Data stays at hospitals (never centralized)
- âœ… Only model updates shared
- âœ… Weighted aggregation (FedAvg)
- âœ… Differential privacy ready (configurable)

## ğŸ“Š Training Output

```
ğŸš€ Starting Federated Learning Training
ğŸ“ Round 1/6
ğŸ¥ Training at local hospitals:
   Metro General Hospital:
      â”œâ”€ Accuracy: 0.7845
      â”œâ”€ Loss: 0.5234
      â””â”€ Val Accuracy: 0.7621
ğŸ”„ Aggregating updates from 8 clients...
ğŸ’¾ Saved global model checkpoint
ğŸ“Š Round 1 Results:
   â€¢ Global Accuracy: 0.7800
   â€¢ Participating Hospitals: 8
   â€¢ Total Samples: 12000
```

## ğŸ› Troubleshooting

### Model Not Found
```bash
âš ï¸  Federated model not found
```
**Solution**: Run `cd federated && python fl_server.py`

### TensorFlow Errors
```bash
pip install --upgrade tensorflow
```

### CORS Errors
Frontend URL is whitelisted in `app.py`. Update if deploying.

## ğŸš¢ Deployment

### Backend Deployment Options

1. **Heroku**
   ```bash
   heroku create medai-backend
   git push heroku main
   ```

2. **Railway.app**
   - Connect GitHub repo
   - Set Python runtime
   - Auto-deploys on push

3. **Render.com**
   - Create Web Service
   - Build command: `pip install -r requirements.txt`
   - Start command: `python app.py`

### Update Frontend API URL

After deploying backend, update `src/pages/PredictionPage.tsx`:

```typescript
const API_URL = 'https://your-backend-url.com';
```

## ğŸ“ Notes

- **Demo Data**: Training uses synthetic data. Replace with real dataset.
- **Model Loading**: Uncomment model loading code in `app.py` lines 36-43.
- **Production**: Add authentication, rate limiting, and monitoring.
- **Scalability**: Use Redis for model caching in production.

## ğŸ†˜ Support

- Check logs: `tail -f app.log`
- Test endpoint: `curl http://localhost:5000/api/health`
- Validate models: Ensure `.h5` files are valid Keras models

## ğŸ“– Further Reading

- [Federated Learning Paper](https://arxiv.org/abs/1602.05629)
- [TensorFlow Federated](https://www.tensorflow.org/federated)
- [Privacy in ML](https://developers.google.com/machine-learning/practica/privacy)
