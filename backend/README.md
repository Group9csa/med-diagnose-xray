# MedAI Backend - Federated Learning for Pneumonia Detection

Backend API for MedAI with federated learning support.

## 📁 Directory Structure

```
backend/
├── app.py                          # Main Flask application
├── requirements.txt                # Python dependencies
├── uploads/                        # Uploaded X-ray images
├── static/
│   └── gradcam_output/            # Grad-CAM visualization outputs
└── federated/                     # Federated learning module
    ├── __init__.py
    ├── fl_server.py               # Federated server orchestration
    ├── fl_client.py               # Hospital client simulation
    ├── fl_aggregator.py           # FedAvg aggregation
    ├── fl_config.py               # Configuration
    └── federated_api.py           # API endpoints
```

## 🚀 Quick Start

### 1. Install Dependencies

```bash
cd backend
pip install -r requirements.txt
```

### 2. Place Model Files

Put your trained models in the `models/` directory:

```
../models/
├── cnn_model.h5
├── vgg19_model.h5
├── resnet50_model.h5
├── densenet121_model.h5
└── federated/
    ├── global_model.h5         # Generated by training
    ├── training_history.json   # Generated by training
    └── rounds/                 # Generated by training
```

### 3. Train Federated Model (One-time)

```bash
cd federated
python fl_server.py
```

This will:
- ✅ Initialize 8 hospital clients
- ✅ Simulate data distribution
- ✅ Train for 6 rounds
- ✅ Save `global_model.h5`
- ✅ Generate training history

**Note**: Training uses simulated data. Replace with real chest X-ray dataset in production.

### 4. Start Backend Server

```bash
cd ..  # Back to backend/
python app.py
```

Server runs on `http://localhost:5000`

## 🔌 API Endpoints

### Standard Models

- **POST** `/api/predict` - Make prediction with any model
  - Body: `multipart/form-data`
  - Fields: `image` (file), `model` (string)

- **GET** `/api/models/metrics` - Get model performance metrics

### Federated Learning

- **POST** `/api/federated/predict` - Predict using federated model
- **GET** `/api/federated/status` - Check training status
- **GET** `/api/federated/history` - Get training history
- **GET** `/api/federated/hospitals` - Get hospital information

### Utility

- **GET** `/api/health` - Health check
- **GET** `/` - API information

## 🏥 Federated Learning Configuration

Edit `federated/fl_config.py`:

```python
FL_CONFIG = {
    'num_clients': 8,              # Number of hospitals
    'rounds': 6,                   # Training rounds
    'epochs_per_round': 5,         # Local epochs
    'batch_size': 32,
    'learning_rate': 0.001,
}
```

## 🔐 Privacy Features

- ✅ Data stays at hospitals (never centralized)
- ✅ Only model updates shared
- ✅ Weighted aggregation (FedAvg)
- ✅ Differential privacy ready (configurable)

## 📊 Training Output

```
🚀 Starting Federated Learning Training
📍 Round 1/6
🏥 Training at local hospitals:
   Metro General Hospital:
      ├─ Accuracy: 0.7845
      ├─ Loss: 0.5234
      └─ Val Accuracy: 0.7621
🔄 Aggregating updates from 8 clients...
💾 Saved global model checkpoint
📊 Round 1 Results:
   • Global Accuracy: 0.7800
   • Participating Hospitals: 8
   • Total Samples: 12000
```

## 🐛 Troubleshooting

### Model Not Found
```bash
⚠️  Federated model not found
```
**Solution**: Run `cd federated && python fl_server.py`

### TensorFlow Errors
```bash
pip install --upgrade tensorflow
```

### CORS Errors
Frontend URL is whitelisted in `app.py`. Update if deploying.

## 🚢 Deployment

### Backend Deployment Options

1. **Heroku**
   ```bash
   heroku create medai-backend
   git push heroku main
   ```

2. **Railway.app**
   - Connect GitHub repo
   - Set Python runtime
   - Auto-deploys on push

3. **Render.com**
   - Create Web Service
   - Build command: `pip install -r requirements.txt`
   - Start command: `python app.py`

### Update Frontend API URL

After deploying backend, update `src/pages/PredictionPage.tsx`:

```typescript
const API_URL = 'https://your-backend-url.com';
```

## 📝 Notes

- **Demo Data**: Training uses synthetic data. Replace with real dataset.
- **Model Loading**: Uncomment model loading code in `app.py` lines 36-43.
- **Production**: Add authentication, rate limiting, and monitoring.
- **Scalability**: Use Redis for model caching in production.

## 🆘 Support

- Check logs: `tail -f app.log`
- Test endpoint: `curl http://localhost:5000/api/health`
- Validate models: Ensure `.h5` files are valid Keras models

## 📖 Further Reading

- [Federated Learning Paper](https://arxiv.org/abs/1602.05629)
- [TensorFlow Federated](https://www.tensorflow.org/federated)
- [Privacy in ML](https://developers.google.com/machine-learning/practica/privacy)
